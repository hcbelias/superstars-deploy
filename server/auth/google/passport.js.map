{"version":3,"sources":["auth/google/passport.js"],"names":["setup","User","config","use","clientID","google","clientSecret","callbackURL","accessToken","refreshToken","profile","done","email","emails","value","fields","split","username","domain","findOne","exec","then","message","user","name","displayName","provider","_json","save","catch","err"],"mappings":";;;;;QAIgBA,K,GAAAA,K;;AAJhB;;;;AACA;;AACA;;;;;;AAEO,SAASA,KAAT,CAAeC,IAAf,EAAqBC,MAArB,EAA6B;AAClC,qBAASC,GAAT,CAAa,kCAAmB;AAC9BC,cAAUF,OAAOG,MAAP,CAAcD,QADM;AAE9BE,kBAAcJ,OAAOG,MAAP,CAAcC,YAFE;AAG9BC,iBAAaL,OAAOG,MAAP,CAAcE;AAHG,GAAnB,EAKb,UAASC,WAAT,EAAsBC,YAAtB,EAAoCC,OAApC,EAA6CC,IAA7C,EAAmD;AACjD,QAAMC,QAAQF,QAAQG,MAAR,CAAe,CAAf,EAAkBC,KAAhC;AACA,QAAMC,SAASH,MAAMI,KAAN,CAAY,GAAZ,CAAf;AACA,QAAMC,WAAWF,OAAO,CAAP,CAAjB;AACA,QAAMG,SAASH,OAAO,CAAP,CAAf;AACAd,SAAKkB,OAAL,CAAa,EAAC,YAAYF,QAAb,EAAb,EAAsCG,IAAtC,GACGC,IADH,CACQ,gBAAQ;;AAEZ,UAAGnB,OAAOgB,MAAP,KAAkBA,MAArB,EAA4B;AAC1B,eAAOP,KAAK,IAAL,EAAW,KAAX,EAAkB,EAAEW,SAAU,+BAAZ,EAAlB,CAAP;AACD;;AAED,UAAIC,IAAJ,EAAU;AACR,eAAOZ,KAAK,IAAL,EAAWY,IAAX,CAAP;AACD;;AAEDA,aAAO,IAAItB,IAAJ,CAAS;AACduB,cAAMd,QAAQe,WADA;AAEdb,eAAOA,KAFO;AAGdK,kBAAUA,QAHI;AAIdS,kBAAU,QAJI;AAKdrB,gBAAQK,QAAQiB;AALF,OAAT,CAAP;AAOAJ,WAAKK,IAAL,GACGP,IADH,CACQ;AAAA,eAAQV,KAAK,IAAL,EAAWY,IAAX,CAAR;AAAA,OADR,EAEGM,KAFH,CAES;AAAA,eAAOlB,KAAKmB,GAAL,CAAP;AAAA,OAFT;AAGD,KArBH,EAsBGD,KAtBH,CAsBS;AAAA,aAAOlB,KAAKmB,GAAL,CAAP;AAAA,KAtBT;AAuBD,GAjCY,CAAb;AAkCD","file":"auth/google/passport.js","sourcesContent":["import passport from 'passport';\r\nimport {Strategy as GoogleStrategy} from 'passport-google-oauth20';\r\nimport error from '../../components/errors';\r\n\r\nexport function setup(User, config) {\r\n  passport.use(new GoogleStrategy({\r\n    clientID: config.google.clientID,\r\n    clientSecret: config.google.clientSecret,\r\n    callbackURL: config.google.callbackURL\r\n  },\r\n  function(accessToken, refreshToken, profile, done) {\r\n    const email = profile.emails[0].value;\r\n    const fields = email.split('@');\r\n    const username = fields[0];\r\n    const domain = fields[1];\r\n    User.findOne({'username': username }).exec()\r\n      .then(user => {\r\n\r\n        if(config.domain !== domain){\r\n          return done(null, false, { message : \"error-message-invalid-account\" });\r\n        }\r\n\r\n        if (user) {\r\n          return done(null, user);\r\n        }\r\n\r\n        user = new User({\r\n          name: profile.displayName,\r\n          email: email,\r\n          username: username,\r\n          provider: 'google',\r\n          google: profile._json\r\n        });\r\n        user.save()\r\n          .then(user => done(null, user))\r\n          .catch(err => done(err));\r\n      })\r\n      .catch(err => done(err));\r\n  }));\r\n}\r\n"],"sourceRoot":"/source/"}
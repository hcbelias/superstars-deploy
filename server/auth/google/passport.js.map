{"version":3,"sources":["auth/google/passport.js"],"names":["setup","getDataFromDB","User","username","domain","email","profile","token","done","findOne","exec","then","tokenObject","undefined","user","name","displayName","provider","google","_json","save","catch","err","config","use","clientID","clientSecret","callbackURL","accessToken","refreshToken","emails","value","fields","split","console","log","endpoint","ssoUrl","error","response","body","statusCode","statusMessage","bodyToken","message","contentType","headers","JSON","parse"],"mappings":"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","file":"auth/google/passport.js","sourcesContent":["import passport from 'passport';\nimport {Strategy as GoogleStrategy} from 'passport-google-oauth20';\nimport error from '../../components/errors';\nimport config from '../../config/environment'\nimport request from 'request';\n\nfunction getDataFromDB(User, username, domain, email, profile, token, done){\n  User.findOne({'username': username }).exec()\n   .then(user => {\n     const tokenObject = token ? { 'ssoToken':  token} : undefined;\n     if (user) {\n       return done(null, user, tokenObject);\n     }\n\n     user = new User({\n       name: profile.displayName,\n       email: email,\n       username: username,\n       provider: 'google',\n       google: profile._json\n     });\n\n     user.save()\n       .then(user => done(null, user, tokenObject))\n       .catch(err => done(err));\n   })\n   .catch(err => done(err));\n\n}\n\nexport function setup(User, config) {\n  passport.use(new GoogleStrategy({\n    clientID: config.google.clientID,\n    clientSecret: config.google.clientSecret,\n    callbackURL: config.google.callbackURL\n  },\n  function(accessToken, refreshToken, profile, done) {\n    const email = profile.emails[0].value;\n    const fields = email.split('@');\n    const username = fields[0];\n    const domain = fields[1];\n    console.log('Google accessToken: ' + accessToken);\n    let endpoint = `${config.ssoUrl}?access_token=${accessToken}`;\n\n    request(endpoint, function(error, response, body){\n      console.log('SSO endpoint: ' + endpoint);\n      console.log('SSO response: ' + response.statusCode + ' - ' + response.statusMessage);\n\n      let bodyToken;\n      \n\n      if(config.domain !== domain){\n        return done(null, false, { message : \"error-message-invalid-account\" });\n      }\n      \n      if(error){\n        console.log('SSO Error: ' + error);\n      }\n\n      const contentType = response.headers['content-type'];\n      console.log('SSO content type: ' + contentType);\n      switch (response.statusCode) {\n        case 200:\n          if(contentType === \"text/html; charset=utf-8\"){\n            bodyToken = { token: `${endpoint} + - 200 HTML` };\n            console.log('SSO 200 Status Code returning HTML: ' + response.body);\n          }else if(contentType === \"application/json; charset=utf-8\"){\n            bodyToken = JSON.parse(body);\n            console.log('SSO accessToken: ' + bodyToken.token);\n          }else{\n            bodyToken = { token: `${endpoint} + - 200 Unknown` };\n            console.log('SSO 200 Status Code returning content not identified: ' + response.body);\n          }\n          break;\n        case 401:\n          bodyToken = { token: `${endpoint} + - 401` };\n          console.log('SSO Unauthorized.');\n          break;\n        case 500:\n          bodyToken = { token: `${endpoint} + - 500` };\n          console.log('SSO Error: ' + body);\n          break;\n        default:\n          bodyToken = { token: `${endpoint} + - None` };\n          console.log('SSO Unrecognized Status Code: ' + body);\n      }\n\n\n      return getDataFromDB(User, username, domain, email, profile, bodyToken, done);\n    });\n\n  }));\n}\n"],"sourceRoot":"/source/"}
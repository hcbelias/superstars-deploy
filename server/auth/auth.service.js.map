<<<<<<< HEAD
{"version":3,"sources":["auth/auth.service.js"],"names":["isAuthenticated","hasRole","signToken","setTokenCookie","hasPermissionToEdit","hasPermissionToAddEntity","validateJwt","secret","secrets","session","use","req","res","next","query","hasOwnProperty","headers","authorization","access_token","findById","user","_id","exec","then","status","end","catch","err","roleRequired","Error","meetsRequirements","userRoles","indexOf","role","send","id","sign","expiresIn","authInfo","ssoToken","token","cookie","redirect","hasPermission","userData","username","message"],"mappings":"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","file":"auth/auth.service.js","sourcesContent":["'use strict';\r\n\r\nimport passport from 'passport';\r\nimport config from '../config/environment';\r\nimport jwt from 'jsonwebtoken';\r\nimport expressJwt from 'express-jwt';\r\nimport compose from 'composable-middleware';\r\nimport User from '../api/user/user.model';\r\n\r\nvar validateJwt = expressJwt({\r\n  secret: config.secrets.session\r\n});\r\n\r\n/**\r\n * Attaches the user object to the request if authenticated\r\n * Otherwise returns 403\r\n */\r\nexport function isAuthenticated() {\r\n  return compose()\r\n    // Validate jwt\r\n    .use(function (req, res, next) {\r\n      // allow access_token to be passed through query parameter as well\r\n      if (req.query && req.query.hasOwnProperty('access_token')) {\r\n        req.headers.authorization = 'Bearer ' + req.query.access_token;\r\n      }\r\n      validateJwt(req, res, next);\r\n    })\r\n    // Attach user to request\r\n    .use(function (req, res, next) {\r\n      User.findById(req.user._id).exec()\r\n        .then(user => {\r\n          if (!user) {\r\n            return res.status(401).end();\r\n          }\r\n          req.user = user;\r\n          next();\r\n          return null;\r\n        })\r\n        .catch(err => next(err));\r\n    });\r\n}\r\n\r\n/**\r\n * Checks if the user role meets the minimum requirements of the route\r\n */\r\nexport function hasRole(roleRequired) {\r\n  if (!roleRequired) {\r\n    throw new Error('Required role needs to be set');\r\n  }\r\n\r\n  return compose()\r\n    .use(isAuthenticated())\r\n    .use(function meetsRequirements(req, res, next) {\r\n      if (config.userRoles.indexOf(req.user.role) >=\r\n        config.userRoles.indexOf(roleRequired)) {\r\n        next();\r\n      } else {\r\n        res.status(403).send('Forbidden');\r\n      }\r\n    });\r\n}\r\n\r\n/**\r\n * Returns a jwt token signed by the app secret\r\n */\r\nexport function signToken(id, role) {\r\n  return jwt.sign({\r\n    _id: id,\r\n    role: role\r\n  }, config.secrets.session, {\r\n    expiresIn: 60 * 60 * 5\r\n  });\r\n}\r\n\r\n/**\r\n * Set token cookie directly for oAuth strategies\r\n */\r\nexport function setTokenCookie(req, res) {\r\n  if (!req.user) {\r\n    return res.status(404).send('It looks like you aren\\'t logged in, please try again.');\r\n  }\r\n\r\n  if(req.authInfo && req.authInfo.ssoToken && req.authInfo.ssoToken.token){\r\n      res.cookie('ssotoken', req.authInfo.ssoToken.token);\r\n  }\r\n\r\n  res.cookie('token', signToken(req.user._id, req.user.role));\r\n  res.redirect('/');\r\n}\r\n\r\n\r\nexport function hasPermissionToEdit(req, res) {\r\n  return compose()\r\n    .use(isAuthenticated())\r\n    .use(function hasPermission(req, res, next) {\r\n      var userData = req.user;\r\n      if (userData.username === req.user.username || req.user.role === 'admin') {\r\n        next();\r\n      } else {\r\n        res.status(403).send({\r\n          message: 'This user does not have permission to edit.'\r\n        });\r\n      }\r\n    });\r\n}\r\n\r\nexport function hasPermissionToAddEntity(req, res) {\r\n  return compose()\r\n    .use(isAuthenticated())\r\n    .use(function hasPermission(req, res, next) {\r\n      if (req.user.role === 'admin') {\r\n        next();\r\n      } else {\r\n        res.status(403).send({\r\n          message: 'This user does not have permission to edit.'\r\n        });\r\n      }\r\n    });\r\n}\r\n"],"sourceRoot":"/source/"}
=======
{"version":3,"sources":["auth/auth.service.js"],"names":["isAuthenticated","hasRole","signToken","setTokenCookie","hasPermissionToEdit","hasPermissionToAddEntity","validateJwt","secret","secrets","session","use","req","res","next","query","hasOwnProperty","headers","authorization","access_token","findById","user","_id","exec","then","status","end","catch","err","roleRequired","Error","meetsRequirements","userRoles","indexOf","role","send","id","sign","expiresIn","authInfo","ssoToken","token","cookie","redirect","hasPermission","userData","username","message"],"mappings":"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","file":"auth/auth.service.js","sourcesContent":["'use strict';\n\nimport passport from 'passport';\nimport config from '../config/environment';\nimport jwt from 'jsonwebtoken';\nimport expressJwt from 'express-jwt';\nimport compose from 'composable-middleware';\nimport User from '../api/user/user.model';\n\nvar validateJwt = expressJwt({\n  secret: config.secrets.session\n});\n\n/**\n * Attaches the user object to the request if authenticated\n * Otherwise returns 403\n */\nexport function isAuthenticated() {\n  return compose()\n    // Validate jwt\n    .use(function (req, res, next) {\n      // allow access_token to be passed through query parameter as well\n      if (req.query && req.query.hasOwnProperty('access_token')) {\n        req.headers.authorization = 'Bearer ' + req.query.access_token;\n      }\n      validateJwt(req, res, next);\n    })\n    // Attach user to request\n    .use(function (req, res, next) {\n      User.findById(req.user._id).exec()\n        .then(user => {\n          if (!user) {\n            return res.status(401).end();\n          }\n          req.user = user;\n          next();\n          return null;\n        })\n        .catch(err => next(err));\n    });\n}\n\n/**\n * Checks if the user role meets the minimum requirements of the route\n */\nexport function hasRole(roleRequired) {\n  if (!roleRequired) {\n    throw new Error('Required role needs to be set');\n  }\n\n  return compose()\n    .use(isAuthenticated())\n    .use(function meetsRequirements(req, res, next) {\n      if (config.userRoles.indexOf(req.user.role) >=\n        config.userRoles.indexOf(roleRequired)) {\n        next();\n      } else {\n        res.status(403).send('Forbidden');\n      }\n    });\n}\n\n/**\n * Returns a jwt token signed by the app secret\n */\nexport function signToken(id, role) {\n  return jwt.sign({\n    _id: id,\n    role: role\n  }, config.secrets.session, {\n    expiresIn: 60 * 60 * 5\n  });\n}\n\n/**\n * Set token cookie directly for oAuth strategies\n */\nexport function setTokenCookie(req, res) {\n  if (!req.user) {\n    return res.status(404).send('It looks like you aren\\'t logged in, please try again.');\n  }\n\n  if(req.authInfo && req.authInfo.ssoToken && req.authInfo.ssoToken.token){\n      res.cookie('ssotoken', req.authInfo.ssoToken.token);\n  }\n\n  res.cookie('token', signToken(req.user._id, req.user.role));\n  res.redirect('/');\n}\n\n\nexport function hasPermissionToEdit(req, res) {\n  return compose()\n    .use(isAuthenticated())\n    .use(function hasPermission(req, res, next) {\n      var userData = req.user;\n      if (userData.username === req.user.username || req.user.role === 'admin') {\n        next();\n      } else {\n        res.status(403).send({\n          message: 'This user does not have permission to edit.'\n        });\n      }\n    });\n}\n\nexport function hasPermissionToAddEntity(req, res) {\n  return compose()\n    .use(isAuthenticated())\n    .use(function hasPermission(req, res, next) {\n      if (req.user.role === 'admin') {\n        next();\n      } else {\n        res.status(403).send({\n          message: 'This user does not have permission to edit.'\n        });\n      }\n    });\n}\n"],"sourceRoot":"/source/"}
>>>>>>> bc91ee08e9e6517c8560ea071542bc2cbedb4f7e

{"version":3,"sources":["api/user/user.profile.lockmanager.js"],"names":["ProfileLockManager","options","profiles","sessions","maxAllowedLocks","maxLockName","profileId","profile","lockCount","locks","client","id","clientId","session","releaseClientLocks","roomName","getRoomName","error","clientErrorEmitter","leave","join","createSession","sendLockList","attachDisconnectListener","destroySession","lockName","getProfile","length","name","time","Date","getTime","notifyAcquiredLock","lockNames","forEach","releaseLock","lock","warning","clientWarningEmitter","notifyReleasedLock","emit","room","broadcast","to","once","message"],"mappings":"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","file":"api/user/user.profile.lockmanager.js","sourcesContent":["class ProfileLockManager {\r\n  constructor(options) {\r\n    options = options || {};\r\n\r\n    this.profiles = {};\r\n    this.sessions = {};\r\n    this.maxAllowedLocks = options.maxAllowedLocks || 10;\r\n    this.maxLockName = options.maxLockName || 50;\r\n  }\r\n\r\n  getRoomName(profileId) {\r\n    return 'profile:edit:room:' + profileId;\r\n  }\r\n\r\n  getProfile(profileId) {\r\n    var profile = this.profiles[profileId];\r\n\r\n    if(!profile) {\r\n      profile = {\r\n        lockCount: 0,\r\n        locks: {}\r\n      };\r\n\r\n      if(profileId > 0) {\r\n        this.profiles[profileId] = profile;\r\n      }\r\n    }\r\n\r\n    return profile;\r\n  }\r\n\r\n  createSession(client, profileId) {\r\n    this.sessions[client.id] = {\r\n      clientId: client.id,\r\n      profileId: profileId,\r\n      lockCount: 0,\r\n      locks: {}\r\n    };\r\n\r\n    return this.sessions[client.id];\r\n  }\r\n\r\n  destroySession(client) {\r\n    var session = this.sessions[client.id];\r\n\r\n    if(!session) {\r\n      return;\r\n    }\r\n\r\n    this.releaseClientLocks(client);\r\n    delete this.sessions[client.id];\r\n  }\r\n\r\n  join(client, profileId) {\r\n    var roomName = this.getRoomName(profileId),\r\n        error = this.clientErrorEmitter(client);\r\n\r\n    if(profileId <= 0) {\r\n      return error('Invalid profile id (' + profileId + ')');\r\n    }\r\n\r\n    this.leave(client);\r\n\r\n    client.join(roomName, () => {\r\n      this.createSession(client, profileId);\r\n      this.sendLockList(client, profileId);\r\n    });\r\n\r\n    this.attachDisconnectListener(client);\r\n  }\r\n\r\n  leave(client) {\r\n    var session = this.sessions[client.id],\r\n        profileId = session ? session.profileId : 0,\r\n        roomName = this.getRoomName(profileId);\r\n\r\n    if(session) {\r\n      client.leave(roomName);\r\n    }\r\n\r\n    this.destroySession(client);\r\n  }\r\n\r\n  acquireLock(client, lockName) {\r\n    var session = this.sessions[client.id],\r\n        profileId = session ? session.profileId : 0,\r\n        profile = this.getProfile(profileId),\r\n        error = this.clientErrorEmitter(client);\r\n\r\n    if(!session) {\r\n      return error('The session has not been started');\r\n    }\r\n\r\n    if(!lockName) {\r\n      return error('Lock name is undefined');\r\n    } else if(lockName.length > this.maxLockName) {\r\n      return error('Lock name must not exceed ' + this.maxLockName + ' characters');\r\n    }\r\n\r\n    if(profile.locks[lockName]) {\r\n      if(profile.locks[lockName].clientId !== client.id) {\r\n        return error(lockName + ' has already been acquired by other client');\r\n      }\r\n\r\n      return true;\r\n    } else {\r\n      if(session.lockCount >= this.maxAllowedLocks) {\r\n        return error('The client reached the maximum number of allowed locks (' + session.lockCount + ')');\r\n      }\r\n\r\n      profile.lockCount++;\r\n      profile.locks[lockName] = {\r\n        name: lockName,\r\n        clientId: client.id\r\n      };\r\n\r\n      session.lockCount++;\r\n      session.locks[lockName] = {\r\n        name: lockName,\r\n        time: (new Date()).getTime()\r\n      }\r\n    }\r\n\r\n    this.notifyAcquiredLock(client, profileId, lockName);\r\n    return true;\r\n  }\r\n\r\n  releaseClientLocks(client) {\r\n    let session = this.sessions[client.id],\r\n        lockNames = session ? Object.keys(session.locks) : [];\r\n\r\n    if(!session) {\r\n      return;\r\n    }\r\n\r\n    lockNames.forEach((lockName) => {\r\n      this.releaseLock(client, lockName);\r\n    });\r\n  }\r\n\r\n  releaseLock(client, lockName) {\r\n    var session = this.sessions[client.id],\r\n        profileId = session ? session.profileId : 0,\r\n        profile = this.getProfile(profileId),\r\n        lock = profile.locks[lockName],\r\n        error = this.clientErrorEmitter(client),\r\n        warning = this.clientWarningEmitter(client);\r\n\r\n    if(!session) {\r\n      return error('The session has not been started for this client');\r\n    }\r\n\r\n    if(!lock) {\r\n      return warning(lockName + ' does not exists');\r\n    }\r\n\r\n    if(lock.clientId !== client.id) {\r\n      return error(lockName + ' has been acquired by other client ');\r\n    }\r\n\r\n    delete session.locks[lockName];\r\n    session.lockCount--;\r\n\r\n    delete profile.locks[lockName];\r\n    profile.lockCount--;\r\n\r\n    if(!profile.lockCount) {\r\n      delete this.profiles[profileId];\r\n    }\r\n\r\n    this.notifyReleasedLock(client, profileId, lockName);\r\n    return true;\r\n  }\r\n\r\n  sendLockList(client) {\r\n   var session = this.sessions[client.id] || {},\r\n       profile = this.profiles[session.profileId || 0] || {},\r\n       locks = profile.locks || {};\r\n\r\n    client.emit('profile:lock:list', locks);\r\n  }\r\n\r\n  notifyAcquiredLock(client, profileId, lockName) {\r\n    var room = this.getRoomName(profileId);\r\n\r\n    client.broadcast.to(room).emit('profile:lock:acquired', {\r\n      name: lockName\r\n    });\r\n  }\r\n\r\n  notifyReleasedLock(client, profileId, lockName) {\r\n    var room = this.getRoomName(profileId);\r\n\r\n    client.broadcast.to(room).emit('profile:lock:released', {\r\n      name: lockName\r\n    });\r\n  }\r\n\r\n  attachDisconnectListener(client) {\r\n    client.once('disconnect', () => {\r\n      this.leave(client);\r\n    });\r\n  }\r\n\r\n  clientErrorEmitter(client) {\r\n    return (message) => {\r\n      client.emit('profile:lock:error', message);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  clientWarningEmitter(client) {\r\n    return (message) => {\r\n      client.emit('profile:lock:warning', message);\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\nexport default ProfileLockManager;\r\n"],"sourceRoot":"/source/"}
{"version":3,"sources":["api/user/user.controller.js"],"names":["index","show","update","me","searchBySkill","authCallback","respondWithBasicProfileResult","res","statusCode","entity","status","end","json","profile","respondWithBasicProfileResultList","results","users","i","length","push","respondWithCompleteProfileResult","sortResults","completeProfile","education","experiences","certifications","validationError","err","handleError","send","addQuerySearchSkill","queryTerms","searchRegExp","skillsCloud","$elemMatch","skill","$regex","getQuerySearchSkill","querystring","query","searchTerms","q","split","RegExp","$or","getQuerySearchAllFields","name","currentPosition","currentClient","currentProject","client","project","req","find","or","exec","then","catch","next","username","params","findOne","body","findOneAndUpdate","new","userId","user","_id","console","log","redirect","arr","field","asc","sort","el1","el2"],"mappings":"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","file":"api/user/user.controller.js","sourcesContent":["'use strict';\r\n\r\nimport User from './user.model';\r\nimport passport from 'passport';\r\nimport config from '../../config/environment';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nfunction respondWithBasicProfileResult(res, statusCode) {\r\n  statusCode = statusCode || 200;\r\n  return function(entity) {\r\n    if (!entity)\r\n      return res.status(404).end();\r\n\r\n    return res.status(statusCode).json(entity.profile);\r\n  };\r\n}\r\n\r\nfunction respondWithBasicProfileResultList(res, statusCode) {\r\n  var results =[];\r\n  statusCode = statusCode || 200;\r\n  return function(users) {\r\n    if(!users)\r\n      return res.status(200).json(results);\r\n\r\n    for(var i = 0; i < users.length; i++){\r\n      results.push(users[i].profile);\r\n    }\r\n    return res.status(200).json(results);\r\n  };\r\n}\r\nfunction respondWithCompleteProfileResult(res, statusCode) {\r\n  statusCode = statusCode || 200;\r\n  return function(entity) {\r\n    if (!entity) {\r\n      return res.status(404).end();\r\n    }\r\n\r\n    sortResults(entity.completeProfile.education, 'startDate', false);\r\n    sortResults(entity.completeProfile.experiences, 'startDate', false);\r\n    sortResults(entity.completeProfile.certifications, 'startDate', false);\r\n\r\n    return res.status(statusCode).json(entity.completeProfile);\r\n  };\r\n}\r\n\r\nfunction validationError(res, statusCode) {\r\n  statusCode = statusCode || 422;\r\n  return function(err) {\r\n    return res.status(statusCode).json(err);\r\n  }\r\n}\r\n\r\nfunction handleError(res, statusCode) {\r\n  statusCode = statusCode || 500;\r\n  return function(err) {\r\n    return res.status(statusCode).send(err);\r\n  };\r\n}\r\n\r\nfunction addQuerySearchSkill(queryTerms, searchRegExp){\r\n  queryTerms.push({\r\n    skillsCloud: {\r\n      $elemMatch: {\r\n        skill: {\r\n          $regex: searchRegExp\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nfunction getQuerySearchSkill(querystring){\r\n  var query = {},\r\n    searchTerms,\r\n    queryTerms = [],\r\n    searchRegExp;\r\n\r\n  //Check if there are query strings\r\n  if (Object.keys(querystring).length !== 0) {\r\n    searchTerms = querystring.q.split(' ');\r\n    for (var i = 0; i < searchTerms.length; i++) {\r\n      searchRegExp = new RegExp('.*' + searchTerms[i] + '.*', 'i');\r\n      addQuerySearchSkill(queryTerms, searchRegExp);\r\n    }\r\n    query = { $or: queryTerms }\r\n  }else{\r\n    query = null;\r\n  }\r\n  return query;\r\n}\r\n\r\nfunction getQuerySearchAllFields(querystring){\r\n  var query = {},\r\n    searchTerms,\r\n    queryTerms = [],\r\n    searchRegExp;\r\n\r\n  //Check if there are query strings\r\n  if (Object.keys(querystring).length !== 0) {\r\n    searchTerms = querystring.q.split(' ');\r\n    for (var i = 0; i < searchTerms.length; i++) {\r\n      searchRegExp = new RegExp('.*' + searchTerms[i] + '.*', 'i');\r\n      addQuerySearchSkill(queryTerms, searchRegExp);\r\n      queryTerms.push({\r\n        name: {\r\n          $regex: searchRegExp\r\n        }\r\n      }, {\r\n        currentPosition: {\r\n          $regex: searchRegExp\r\n        }\r\n      }, {\r\n        currentClient: {\r\n          $regex: searchRegExp\r\n        }\r\n      }, {\r\n        currentProject: {\r\n          $regex: searchRegExp\r\n        }\r\n      }, {\r\n        experiences: {\r\n          $elemMatch: {\r\n            client: {\r\n              $regex: searchRegExp\r\n            }\r\n          }\r\n        }\r\n      }, {\r\n        experiences: {\r\n          $elemMatch: {\r\n            project: {\r\n              $regex: searchRegExp\r\n            }\r\n          }\r\n        }\r\n      });\r\n    }\r\n    query =  { $or: queryTerms } ;\r\n  }\r\n  return query;\r\n}\r\n\r\n/**\r\n * Get list of users\r\n * restriction: 'admin'\r\n */\r\nexport function index(req, res) {\r\n  var query = getQuerySearchAllFields(req.query),\r\n    results = [];\r\n\r\n  return User.find().or(query).exec()\r\n    .then(respondWithBasicProfileResultList(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Get a single user\r\n */\r\nexport function show(req, res, next) {\r\n  var username = req.params.username;\r\n\r\n  return User.findOne({ username: username }).exec()\r\n    .then(respondWithCompleteProfileResult(res))\r\n    .catch(err => next(err));\r\n}\r\n\r\n\r\n\r\n/**\r\n * Get a single user\r\n */\r\nexport function update(req, res, next) {\r\n  var username = req.body.username;\r\n\r\n  return User.findOneAndUpdate({ username: username }, req.body, { new: true }).exec()\r\n    .then(respondWithCompleteProfileResult(res))\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n * Get my info\r\n */\r\nexport function me(req, res, next) {\r\n  var userId = req.user._id;\r\n  return User.findOne({ _id: userId }).exec()\r\n    .then(respondWithBasicProfileResult(res))\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n* Search user by skill\r\n*/\r\nexport function searchBySkill(req, res, next){\r\n  var query = getQuerySearchSkill(req.query);\r\n  if(!query){\r\n    return res.status(200).json([]); // if none skill is passed, we dont return users\r\n  }\r\n  console.log(JSON.stringify(query));\r\n  return User.find(query).exec()\r\n    .then(respondWithBasicProfileResultList(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Authentication callback\r\n */\r\nexport function authCallback(req, res, next) {\r\n  res.redirect('/');\r\n}\r\n\r\n/**\r\n* Sort an array of results\r\n*/\r\n\r\nfunction sortResults(arr, field, asc){\r\n  arr = arr.sort(function(el1, el2){\r\n    if(asc){\r\n      return (el1[field] > el2[field]) ? 1 : ((el1[field] < el2[field]) ? -1 : 0);\r\n    }\r\n    else{\r\n      return (el2[field] > el1[field]) ? 1 : ((el2[field] < el1[field]) ? -1 : 0);\r\n    }\r\n  });\r\n}"],"sourceRoot":"/source/"}